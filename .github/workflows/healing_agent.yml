name: Autonomous CI/CD Healing Agent

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub Repository URL to heal'
        required: true
      branch_name:
        description: 'Branch name for AI fixes'
        required: true
      run_id:
        description: 'Unique Run ID'
        required: true
      team_name:
        description: 'Team Name'
        required: true
      leader_name:
        description: 'Leader Name'
        required: true

jobs:
  heal:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Enable pip caching

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --prefer-binary -r requirements.txt
          pip install pytest pytest-json-report pytest-xdist requests gitpython

      - name: Signal Start to Dashboard
        run: |
          mkdir -p backend/results
          echo '{
            "repo_url": "${{ github.event.inputs.repo_url }}",
            "branch_name": "${{ github.event.inputs.branch_name }}",
            "run_id": "${{ github.event.inputs.run_id }}",
            "ci_status": "IN_PROGRESS",
            "ci_timeline": ["Mission initialized", "Cloud Core provisioned successfully", "Spawning LangGraph Healing Engine..."],
            "scoring": {"base_score": 100, "speed_factor": 0, "fix_efficiency": 0, "regression_penalty": 0, "final_ci_score": 0},
            "start_time": '$(date +%s)',
            "elapsed_seconds": 0,
            "team_name": "${{ github.event.inputs.team_name }}",
            "leader_name": "${{ github.event.inputs.leader_name }}"
          }' > backend/results/${{ github.event.inputs.run_id }}.json
          git config --global user.name "AI-Healing-Agent"
          git config --global user.email "agent@codereborn.ai"
          git add -f backend/results/${{ github.event.inputs.run_id }}.json
          git commit -m "status: mission ${{ github.event.inputs.run_id }} active [skip ci]" || echo "No changes"
          git push origin HEAD:main || echo "Push failed, but assuming local data or retry"

      - name: Run Healing Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER || 'gemini' }}
          PYTHONPATH: .
        run: |
          # Create a workspace and clone the target repo there
          mkdir -p workspace
          # Use the provided token for the target repo clone (might be a different owner)
          git clone "${{ github.event.inputs.repo_url }}" "./workspace/${{ github.event.inputs.run_id }}"
          
          python main.py \
            --repo-path "./workspace/${{ github.event.inputs.run_id }}" \
            --repo-url "${{ github.event.inputs.repo_url }}" \
            --branch "${{ github.event.inputs.branch_name }}" \
            --run-id "${{ github.event.inputs.run_id }}"

      - name: Final Commit and Push
        if: always()
        run: |
          git config --global user.name "AI-Healing-Agent"
          git config --global user.email "agent@codereborn.ai"
          git add -f backend/results/
          git commit -m "chore: final results for ${{ github.event.inputs.run_id }} [skip ci]" || echo "No changes"
          git push origin HEAD:main
